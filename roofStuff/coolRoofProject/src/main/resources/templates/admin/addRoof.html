<!DOCTYPE html>
<html lang="en">
  
  <head>
    <title>Add roof</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/home.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/investor.css}" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script	src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js">
    </script>
    <script	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js">
    </script>
    <script src="https://code.jquery.com/jquery-latest.js"></script>
  </head>
  
  
  <body>
    
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="pull-left navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">CoolRoofs</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav">
            <li>
              <a href="roofOwner.html">Home</a>
            </li>
            <li class="active">
              <a href="addRoof.html">Add Roof</a>
            </li>
            <li>
              <a href="#">My Roofs(not yet)</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    
    
    <div class="container">
      <h2>Add new Roof</h2>
      <form action="#" th:action="@{/admin/addRoof}" th:object="${roof}" method="post" class="form-horizontal">
        <div class="form-group row">
          <input id ="roofPolygon" type="hidden" name="roofPolygon" th:field="*{roofPolygon}" value=""/>
          <input id ="longitude" type="hidden" name="longitude" th:field="*{longitude}" value=""/>
          <input id ="latitude" type="hidden" name="latitude" th:field="*{latitude}" value=""/>
          <input id ="zoomFactor" type="hidden" name="zoomFactor" th:field="*{zoomFactor}" value=""/>

        
        <h2>Roof Details</h2>
        <div class="row row-height">
          <div class="col-md-6 col-height bordershow">
            <div class="make-investment-right-side">
              <div id="mapsX"></div>
            </div>
          </div>
          <div id="panel">
            <div id="panel-content">
              <div id="controls">
                Select polygon 
                <select id="polyList"></select>
                <button id="btnDelete" onclick="do()">Delete Selected</button>  <!--remove onclick="do()" for original version-->
                <button id="btnDeleteAll">Delete All</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          
        </div>
        
        <div class="form-group">
          <div class="col-xs-3 col-md-3">
            <label for="age">Age</label>
            <label th:if="${#fields.hasErrors('age')}" th:errors="*{age}" class="validation-message"></label>
            <select class="form-control" id="age" th:field="*{age}">
              <div>
                <option disabled="true" selected="selected" value="-1">selected</option>
                <option value="0">0-5 years</option>
                <option value="5">5-10 years</option>
                <option value="10">10-15 years</option>
                <option value="15">15-20 years</option>
                <option value="20">20+ years</option>
              </div>
            </select>
          </div>
          <div class="col-xs-2 col-md-2">
            <label for="area"> Area </label>
            <input type="number" th:field="*{area}" placeholder="area" class="form-control" id="area">
          </div>
          <div class="col-xs-4 col-md-4">
            <label for="material"> Material </label>
            <select class="form-control" id="material" th:field="*{material}">
              <div>
                <option disabled="true" selected="selected" value="">Select</option>
                <option value="Shingle">Shingle</option>
                <option value="Metal">Metal</option>
                <option value="Tile">Tile</option>
              </div>
            </select>
          </div>
        </div>
        
        <h3>Temporary</h3>
        
        <div class="form-group">
          <div class="col-xs-5 col-md-2">
            <label th:if="${#fields.hasErrors('address')}" th:errors="*{address}" class="validation-message"></label>
            <input type="text" th:field="*{address}" placeholder="Address" class="form-control" />
          </div>
          <div class="col-xs-7 col-md-5">
            <label th:if="${#fields.hasErrors('region')}" th:errors="*{region}" class="validation-message"></label>
            <input type="text" th:field="*{region}" placeholder="Region" class="form-control" />
          </div>
        </div>
        
        <div class="form-group">
          <div class="col-xs-12 col-md-7">
            <button type="submit" class="btn btn-primary btn-block">Add Roof</button>
          </div>
        </div>
        
        <span th:utext="${successMessage}"/>
        
      </form>
    </div>
    
    
    <script type="text/javascript">
      var map;
      var coordinates;
      
      function initMap() {
        map = new google.maps.Map(document.getElementById('mapsX'), {
          center: { lat: -34.397, lng: 150.644 },
          zoom: 20,
          // only show roadmap type of map, and disable ability to switch to other type
          mapTypeId: google.maps.MapTypeId.SATELLITE,
          mapTypeControl: false
        });
      	map.data.setControls(['Polygon']);
        map.data.setStyle({
          editable: true,
          draggable: true
        });
        bindDataLayerListeners(map.data); 
        
        //loadPolygons(map);  //load saved data */
      }
      
      // Apply listeners to refresh the GeoJson display on a given data layer.
      function bindDataLayerListeners(dataLayer) {
        dataLayer.addListener('addfeature', savePolygon);
        dataLayer.addListener('removefeature', savePolygon);
      }
      function loadPolygons(map) {
        var data = JSON.parse(localStorage.getItem('geoData')); // this will be needed
       	//alert(data);
        map.data.forEach(function (f) {
          map.data.remove(f);
        });
        map.data.addGeoJson(data) // and this
      }
      function savePolygon() {
        
        map.data.toGeoJson(function (json) {
          localStorage.setItem('geoData', JSON.stringify(json));
          initControls(json);
        }); 
        
        calcar();
      }
      
      function setProperties() {
        map.data.toGeoJson(function (json) {
          document.getElementById('roofPolygon').value = JSON.stringify(json);
          //alert(JSON.stringify(json));
          
          
          var split = coordinates.toString().split(",");
          
          document.getElementById('longitude').value = split[1].substring(0,split[1].length-1);
          document.getElementById('latitude').value = split[0].substring(1,split[0].length);
          document.getElementById('zoomFactor').value = map.getZoom();
        }); 
      }
      
      function initControls(data)
      {
        var sel = document.getElementById('polyList');
        sel.options.length = 0;
        for (var i = 0; i < data.features.length; i++) {
          var opt = document.createElement('option');
          opt.innerHTML = data.features[i].geometry.type;                        
          
          opt.value = i;
          sel.appendChild(opt);
        }
        
        document.getElementById("btnDelete").onclick = do();                              // for my testing
      //  document.getElementById("btnDelete").disabled = (data.features.length === 0);   //original content
        
      //  document.getElementById("btnDelete").onclick = function(){
          
      //   var selIdx = sel.options[sel.selectedIndex].value; //get poly index 
      //    data.features.splice(parseInt(selIdx), 1);   
          //reload 
      //    localStorage.setItem('geoData', JSON.stringify(data));
      //    initControls(data);  
      //    loadPolygons(map);   
      //  };
      }
      
      function do() {
          alert("Im blue");
      }
      
      function calcar() {
        var areasum=0;
        //         var area = google.maps.geometry.spherical.computeArea(selectedShape.getPath());
        //         document.getElementById("test3").innerHTML = "Area =" + area.toFixed(2);
        map.data.forEach(function(feature) {
          if (feature.getGeometry().getType() == "Polygon") {
            var bounds = [];
            var polyBnds = new google.maps.LatLngBounds();
            
            feature.getGeometry().forEachLatLng(function(path) {
              bounds.push(path);
              
              latlngforDB=path;
              
              polyBnds.extend(path);
              coordinates = path;
            });
            console.log(bounds);
            var area = google.maps.geometry.spherical.computeArea(bounds);
            console.log(area);
            area = Math.round(area);
            var iW = new google.maps.InfoWindow({
              content: area + " sq meters",
              content: area + " sq meters",
              position: polyBnds.getCenter()
            });
            iW.open(map);
            areasum +=area;
          }
          
        });
        document.getElementById('area').value = areasum;
        setProperties();
        
      } 
    </script>
    
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGBWhUOkEthohFqecddY4RWSysZtVcIRo&libraries=drawing,geometry&callback=initMap">
    </script> 
    
  </body>
  
</html>